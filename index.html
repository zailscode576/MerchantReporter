<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Traveling Merchant Reporter</title>
<style>
    body {
        font-family: Arial, sans-serif;
        font-size: 16px;
        margin: 20px;
        background: #1e1e2f;
        color: #ddd;
    }
    h2 {
        margin-bottom: 10px;
        color: #fff;
    }
    select, input, button {
        margin: 5px 0;
        padding: 6px;
        font-size: 15px;
        background: #2a2a3d;
        color: #ddd;
        border: 1px solid #555;
        border-radius: 4px;
    }
    select:focus, input:focus {
        outline: none;
        border-color: #888;
    }
    button {
        background: #44445e;
        cursor: pointer;
    }
    button:hover {
        background: #555577;
    }
    .items-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    .item-block {
        flex: 1;
        background: #2a2a3d;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        min-width: 200px;
    }
    label {
        display: block;
        font-weight: bold;
        margin-top: 5px;
        color: #bbb;
        font-size: 14px;
    }
    textarea {
        width: 100%;
        height: 180px;
        margin-top: 10px;
        font-family: monospace;
        font-size: 15px;
        background: #2a2a3d;
        color: #ddd;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #555;
        resize: none;
    }
    .credit {
        position: fixed;
        bottom: 5px;
        left: 10px;
        font-size: 12px;
        color: #888;
        opacity: 0.7;
    }
    .credit:hover {
        opacity: 1;
    }
    #haujenToggleBtn {
        background: #2a2a3d;
        border: 1px solid #555;
        color: #bbb;
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 4px;
        cursor: pointer;
    }
    #haujenToggleBtn.active {
        background: #555;
        color: #fff;
    }
    .cost-buttons {
        display: flex;
        gap: 5px;
        margin-bottom: 5px;
    }
    .cost-btn {
        flex: 1;
        padding: 5px;
        background: #333;
        border: 1px solid #555;
        color: #ddd;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
    }
    .cost-btn.active {
        background: #666;
        border-color: #aaa;
    }
    /* Highlight invalid fields */
    select.invalid {
        border-color: #d66;
        background: #3a1e1e;
    }
    #clearBtn {
        background: #552e2e;
    }
    #clearBtn:hover {
        background: #773e3e;
    }
</style>
</head>
<body>

<h2>Traveling Merchant Reporter</h2>

<label for="location">Merchant Location:</label>
<select id="location">
    <option value="">-- Select Location --</option>
    <option>Azuralite Oasis</option>
    <option>Caldera Island</option>
    <option>Fortune River</option>
    <option>Fortune River Delta</option>
    <option>Sunset Beach</option>
    <option>Windswept Beach</option>
</select>

<div class="items-container" id="items"></div>

<button onclick="copyToClipboard()" id="copyBtn">Copy to Clipboard</button>

<textarea id="output" readonly></textarea>

<button id="clearBtn" onclick="clearForm()">Clear All</button>

<script>
let itemsList = [
    { name: "Perfect Reforge Token", coins: "$50,000,000,000", shards: "5000", stock: 1 },
    { name: "Traveler's Backpack", coins: "$1,000,000,000", shards: "1000", stock: 3 },

    { name: "Solar Token", coins: "$500,000,000", shards: "600", stock: 1, category: "Fragments" },
    { name: "Meteor Fragment", coins: "$5,000,000,000", shards: "1500", stock: 1, category: "Fragments" },
	{ name: "Void Shard", coins: "?", shards: "4,000", stock: 1, category: "Fragments" },

    { name: "Prismatic Enchant Book", coins: "$20,000,000,000", shards: "5000", stock: 1, category: "Enchants" },
    { name: "Infernal Enchant Book", coins: "$20,000,000,000", shards: "5000", stock: 1, category: "Enchants" },
    { name: "Cosmic Enchant Book", coins: "$10,000,000,000", shards: "2000", stock: 1, category: "Enchants" },
    { name: "Divine Enchant Book", coins: "$10,000,000,000", shards: "2000", stock: 1, category: "Enchants" },
    { name: "Blessed Enchant Book", coins: "$200,000,000", shards: "750", stock: 1, category: "Enchants" },
    { name: "Destructive Enchant Book", coins: "$200,000,000", shards: "750", stock: 1, category: "Enchants" },
    { name: "Midas Enchant Book", coins: "$200,000,000", shards: "750", stock: 1, category: "Enchants" },
    { name: "Glowing Enchant Book", coins: "$50,000,000", shards: "400", stock: 1, category: "Enchants" },
    { name: "Titanic Enchant Book", coins: "$50,000,000", shards: "400", stock: 1, category: "Enchants" },
    { name: "Unstable Enchant Book", coins: "$50,000,000", shards: "400", stock: 1, category: "Enchants" },

    { name: "Blitz Potion", coins: "$200,000,000", shards: "250", stock: 3, category: "Potions" },
    { name: "Instability Potion", coins: "$200,000,000", shards: "150", stock: 3, category: "Potions" },
    { name: "Quake Potion", coins: "$200,000,000", shards: "200", stock: 3, category: "Potions" }
];

// Helpers
function parsePrice(str) {
    return parseInt(str.replace(/[^0-9]/g, ""), 10);
}

// UI build
let enchantBooks = itemsList.filter(i => i.category === "Enchants")
    .sort((a, b) => parsePrice(b.coins) - parsePrice(a.coins) || a.name.localeCompare(b.name));
let fragments = itemsList.filter(i => i.category === "Fragments");
let potions = itemsList.filter(i => i.category === "Potions");
let other = itemsList.filter(i => !i.category);

const container = document.getElementById("items");
for (let i = 0; i < 4; i++) {
    const div = document.createElement("div");
    div.className = "item-block";
    div.innerHTML = `
        <label>Item ${i + 1}:</label>
        <select class="item-select">
            <option value="">-- Select Item --</option>
            <optgroup label="Event Summons">
                ${fragments.map(item => `<option value="${item.name}">${item.name}</option>`).join("")}
            </optgroup>
            <optgroup label="Enchants">
                ${enchantBooks.map(item => `<option value="${item.name}">${item.name}</option>`).join("")}
            </optgroup>
            <optgroup label="Potions">
                ${potions.map(item => `<option value="${item.name}">${item.name}</option>`).join("")}
            </optgroup>
            <optgroup label="Other">
                ${other.map(item => `<option value="${item.name}">${item.name}</option>`).join("")}
            </optgroup>
        </select>
        <label>Cost Type:</label>
        <div class="cost-buttons">
            <button type="button" class="cost-btn active" data-type="coins">Coins</button>
            <button type="button" class="cost-btn" data-type="shards">Shards</button>
        </div>
        <input type="hidden" class="cost-type" value="coins">
        <div class="stock-div">
            <label>Stock:</label>
            <input type="number" min="1" class="stock-input" value="1">
        </div>
    `;
    container.appendChild(div);
}

// Copy feedback
let copyResetTimer; // store timer globally

function copyToClipboard() {
    const output = document.getElementById("output");
    output.select();
    output.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(output.value);

    const btn = document.getElementById("copyBtn");
    const oldText = "Copy to Clipboard";

    btn.textContent = "✅ Copied!";
    clearTimeout(copyResetTimer); // clear any previous timer
    copyResetTimer = setTimeout(() => {
        btn.textContent = oldText;
    }, 1000);
}

// Clear all
function clearForm() {
    document.getElementById("location").value = "";
    document.querySelectorAll(".item-select").forEach(sel => sel.value = "");
    document.querySelectorAll(".cost-type").forEach(inp => inp.value = "coins");
    document.querySelectorAll(".stock-input").forEach(inp => inp.value = 1);
    updateReport();
}

// Stock handling
function updateStockField(selectElem) {
    const selectedItem = itemsList.find(item => item.name === selectElem.value);
    const stockDiv = selectElem.parentElement.querySelector(".stock-div");
    if (selectedItem && selectedItem.stock === 1) {
        stockDiv.style.display = "none";
        stockDiv.querySelector(".stock-input").value = 1;
    } else {
        stockDiv.style.display = "block";
        const stockInput = stockDiv.querySelector(".stock-input");
        stockInput.value = selectedItem && selectedItem.stock !== 1 ? selectedItem.stock : 1;
    }
}

// Highlight invalid
function highlightInvalid() {
    const location = document.getElementById("location");
    if (!location.value) location.classList.add("invalid");
    else location.classList.remove("invalid");

    document.querySelectorAll(".item-select").forEach(sel => {
        if (!sel.value) sel.classList.add("invalid");
        else sel.classList.remove("invalid");
    });
}

// Report builder
function updateReport() {
    highlightInvalid();

    const location = document.getElementById("location").value;
    if (!location) {
        document.getElementById("output").value =
            "⚠ Please select a merchant location above.\n\nThe report will appear here once a location is chosen.";
        return;
    }

    const haujenMode = localStorage.getItem("haujenMode") === "true";
    let report = "";

    if (haujenMode) {
        report += `Travelling Merchant Location: **${location}**\n\n`;
    } else {
        report += `**# Traveling Merchant Location and Stock**\n**Location: ${location}**\n\n`;
    }

    const categories = { "Fragments": [], "Enchants": [], "Potions": [], "Other": [] };

    document.querySelectorAll(".item-block").forEach(block => {
        const itemName = block.querySelector(".item-select").value;
        const costType = block.querySelector(".cost-type").value;
        const stockDiv = block.querySelector(".stock-div");
        const stock = stockDiv.style.display === "none" ? 1 : block.querySelector(".stock-input").value;

        if (itemName) {
            const itemData = itemsList.find(item => item.name === itemName);
            const price = costType === "coins" ? itemData.coins : itemData.shards + " Meteor Shards";
            const line = { text: `• \`${stock}x ${itemName} - ${price}\``, sortValue: parsePrice(itemData.coins) };
            const category = itemData.category || "Other";
            categories[category].push(line);
        }
    });

    if (haujenMode) {
        let enchantments = categories["Enchants"];
        let misc = [...categories["Fragments"], ...categories["Potions"], ...categories["Other"]];

        if (enchantments.length > 0) {
            enchantments.sort((a, b) => b.sortValue - a.sortValue);
            report += `**Book Enchantment(s):**\n${enchantments.map(i => i.text).join("\n")}\n\n`;
        }
        if (misc.length > 0) {
            misc.sort((a, b) => b.sortValue - a.sortValue);
            report += `**Miscellaneous:**\n${misc.map(i => i.text).join("\n")}\n\n`;
        }
    } else {
        for (let cat of ["Fragments", "Enchants", "Potions", "Other"]) {
            if (categories[cat].length > 0) {
                let displayName = cat === "Fragments" ? "Event Summons" : cat;
                categories[cat].sort((a, b) => b.sortValue - a.sortValue);
                report += `**${displayName}:**\n${categories[cat].map(i => i.text).join("\n")}\n\n`;
            }
        }
        const unixTime = Math.floor(Date.now() / 1000);
        report += `**Report generated:** <t:${unixTime}:f>\n\n`;
        report += `Vote for dedicated Merchant Channel: https://discord.com/channels/1391817778087858216/1406757447825358922`;
    }

    document.getElementById("output").value = report.trim();
}

// Event listeners
document.getElementById("location").addEventListener("change", updateReport);
document.querySelectorAll(".item-select").forEach(sel => {
    sel.addEventListener("change", function() {
        updateStockField(this);
        updateReport();
    });
});
document.querySelectorAll(".stock-input").forEach(input => {
    input.addEventListener("input", updateReport);
});
document.querySelectorAll(".cost-buttons").forEach(group => {
    const hiddenInput = group.nextElementSibling;
    group.querySelectorAll(".cost-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            group.querySelectorAll(".cost-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            hiddenInput.value = btn.dataset.type;
            updateReport();
        });
    });
});

// Haujen toggle
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("haujenToggleBtn");
    const saved = localStorage.getItem("haujenMode") === "true";
    if (saved) {
        btn.classList.add("active");
        btn.textContent = "Disable Haujen Mode";
    } else {
        btn.textContent = "Enable Haujen Mode";
    }
    btn.addEventListener("click", () => {
        const isActive = btn.classList.toggle("active");
        localStorage.setItem("haujenMode", isActive ? "true" : "false");
        btn.textContent = isActive ? "Disable Haujen Mode" : "Enable Haujen Mode";
        updateReport();
    });
    updateReport(); // auto update on load
});
</script>

<div class="credit">
    Made by zailscode576 | <button id="haujenToggleBtn">Toggle Haujen Mode</button>
</div>

</body>
</html>
